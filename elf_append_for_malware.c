#include <stdio.h>
#include <stdlib.h>
#include "elf_support.h"
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>


int main(int argc, char** argv){
    if(argc < 2){
        printf("Need to specify a path to a file as an argument\n");
        return 1;
    }
    Elf64_Manager* malware = load_elf64_file(argv[1]);
    Elf64_Manager* benign = load_elf64_file(argv[2]);
    int new_section_index = append_new_section(malware, 1024*1024);

    uint8_t* file_section = malware->file_sections[new_section_index];
    Elf64_Xword section_size = malware->s_hdr[new_section_index].sh_size;

    for(int i = 0; i < section_size; i++){
        file_section[i] = 4;
    }
    char buffer[strlen(argv[1])+40];
    strcpy(buffer,argv[1]);
    strcat(buffer,"_fours");
    write_elf64_file(malware, buffer);
    free_manager64(malware);

    malware = load_elf64_file(argv[1]);

    int text_section_index = get_next_section_index_by_name(benign,".text",0);
    printf("Text section index: %d\n",text_section_index);
    Elf64_Xword text_section_size = benign->s_hdr[text_section_index].sh_size;

    new_section_index = append_new_section(malware, text_section_size);
    memcpy(malware->file_sections[new_section_index],benign->file_sections[text_section_index], text_section_size);

    strcpy(buffer,argv[1]);
    strcat(buffer,"_appended_benign_x1");

    write_elf64_file(malware, buffer);


    for(int i = 0; i < 9; i++){
        new_section_index = append_new_section(malware, text_section_size);
        memcpy(malware->file_sections[new_section_index],benign->file_sections[text_section_index], text_section_size);
    }
    strcat(buffer,"0");
    write_elf64_file(malware, buffer);


    free_manager64(malware);

    free_manager64(benign);
    return 0;
}